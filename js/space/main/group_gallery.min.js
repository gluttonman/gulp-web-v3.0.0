function getGalleryStatistics(){var e={};$.ajax({type:"GET",async:!0,data:{random_num:creatRandomNum(),person_id:person_id,identity_id:identity_id},url:url_path_action_login+"/space/gallery/get_stat_num",dataType:"json",success:function(t){e.data=t;var a=template("galleryStatistics_inner",e);$("#galleryStatistics").html(a),$("#allCategory").html("（"+t.pic_num+"）")},error:function(){var t={};t.success=!1,e.data=t;var a=template("galleryStatistics_inner",e);$("#galleryStatistics").html(a),$("#allCategory").html("(0)")}})}function getGalleryCategory(e){var t={};$.ajax({type:"GET",async:!0,data:{random_num:creatRandomNum(),person_id:person_id,identity_id:identity_id,business_type:business_type},url:url_path_action_login+"/space/gallery/get_galleryfolder",dataType:"json",success:function(a){t.data=a;var i=template("galleryCategory_inner",t);$("#galleryCategory").html(i);var o=GetQueryString("gallery_name");null!=o?(o=Base64.decode(o),$("#galleryCategory li a").each(function(){$(this).attr("title")==o&&($(this).parent().removeClass("active"),$(this).parent().addClass("active"),CalleryClick())})):($("#galleryCategory li").removeClass("active"),$("#category_"+cur_category).addClass("active")),bindCategoryClick(),e&&e()},error:function(){var e={};e.success=!1,t.data=e;var a=template("galleryCategory_inner",t);$("#galleryCategory").html(a)}})}function bindCategoryClick(){$("#galleryCategory li").click(function(){$("#galleryCategory li").removeClass("active"),$(this).addClass("active"),CalleryClick()})}function CalleryClick(){getMyGallery(page_number=1,page_size,"replace"),$(":checkbox").attr("checked",!1),null!=(cur_category=$("#galleryCategory li.active input").val())&&""!=cur_category?($(".batch-op .batch-move").show(),$(".batch-op .batch-remove").show(),$(".batch-op .checkbox").show()):($(".batch-op .batch-move").hide(),$(".batch-op .batch-remove").hide(),$(".batch-op .checkbox").hide())}function galleryCategoryManage(){getGalleryCategoryForManage(),dia=art.dialog({content:$("#galleryCategoryManageDialog").html(),width:700,lock:!0,icon:null,title:"相册管理",close:function(){getGalleryCategory(function(){getGalleryStatistics()})},ok:!0})}function getGalleryCategoryForManage(){$("#galleryCategoryManageDialog table tbody").empty(),$.ajax({type:"GET",async:!1,data:{random_num:creatRandomNum(),person_id:person_id,identity_id:identity_id,business_type:business_type},url:url_path_action_login+"/space/gallery/get_galleryfolder",dataType:"json",success:function(e){if(e.success){var t={};t.data=e;var a=template("galleryCategoryManage_inner",t);$("#galleryCategoryManageDialog table tbody").html(a)}},error:function(){var e={};e.success=!1;var t={};t.data=e;var a=template("galleryCategoryManage_inner",t);$("#galleryCategoryManageDialog table tbody").html(a)}})}function editSortManage(e,t,a){var i=null;art.dialog({title:0==e?"增加相册":"修改相册",content:"<div id='editSortDiv' style='width:400px;'><table width='100%' class='table table-info'><tbody><tr><td scope='row' width='72'>相册名称<br/>&nbsp;</td><td colspan='3'><div id='editSortTitle'></div></tr></tbody></table></div>",fixed:!0,lock:!0,width:400,init:function(){i=$("#editSortTitle").input({index:3,placeholder:"请输入相册名称",maxCount:20,showType:1,width:275,onCheck:function(){""==i.input("value")&&i.input("setTips","相册名称不能为空")}}),1==e&&i.input("setVal",$(t).closest("tr").find(".title").html()),$("#editSortTitle").val($.trim($("#editSortTitle").val()).substring(0,20)),$("#editSortHid").text(20-$("#editSortTitle").val().length),$("#editSortTitle").bind("keyup",function(){$("#editSortTitle").val($.trim($("#editSortTitle").val()).substring(0,20)),$("#editSortHid").text(20-$("#editSortTitle").val().length)}).bind("paste",function(){$("#editSortTitle").val($.trim($("#editSortTitle").val()).substring(0,20)),$("#editSortHid").text(20-$("#editSortTitle").val().length)})}},function(){var t=i.input("value");return 0==t.length?(art.dialog.alert("请输入相册名称！"),!1):t.length>20?(art.dialog.alert("相册名称过长！"),!1):void(0==e?$.ajax({type:"POST",async:!1,data:{person_id:person_id,identity_id:identity_id,folder_name:t,business_type:business_type,is_private:"0"},url:url_path_action+"/space/gallery/create_galleryfolder",dataType:"json",success:function(e){e.success?(dialogClose("保存成功！",2,150,""),getGalleryCategoryForManage(),dia.content($("#galleryCategoryManageDialog").html()),getGalleryCategory()):dialogClose("保存失败！",2,150,"")},error:function(){dialogClose("保存失败！",2,150,"")}}):$.ajax({type:"POST",async:!1,data:{folder_name:t,folder_id:a},url:url_path_action+"/space/gallery/edit_galleryfolder",dataType:"json",success:function(e){e.success?(dialogClose("修改成功！",2,150,""),getGalleryCategoryForManage(),dia.content($("#galleryCategoryManageDialog").html()),getGalleryCategory()):dialogClose("修改失败！",2,150,"")},error:function(){dialogClose("修改失败！",2,150,"")}}))},function(){})}function delSortManage(e,t){art.dialog({title:"删除相册",content:'确定删除"'+$(e).closest("tr").find(".title").html()+'"这个相册吗?',fixed:!0,lock:!0,icon:"question"},function(){$.ajax({type:"POST",async:!1,data:{folder_id:t,person_id:person_id,identity_id:identity_id,business_type:business_type},url:url_path_action+"/space/gallery/delete_galleryfolder",dataType:"json",success:function(e){e.success?(dialogClose("删除成功！",2,150,""),getGalleryCategoryForManage(),dia.content($("#galleryCategoryManageDialog").html()),getGalleryCategory()):art.dialog.alert("删除失败！"+e.info)},error:function(){art.dialog.alert("删除失败！"+data.info)}})},function(){})}function getMyGallery(e,t,a){var i={};$.ajax({type:"GET",async:!0,data:{random_num:creatRandomNum(),folder_id:$("#galleryCategory li.active input").val(),business_type:business_type,identity_id:identity_id,person_id:person_id,page_num:e,page_size:t,l_person_id:$.cookie("person_id"),l_identity_id:$.cookie("identity_id")},url:url_path_action_login+"/space/gallery/get_picture",dataType:"json",success:function(t){if(t.success){i.data=t,i.getSrc=getSrc,i.getDownload=getDownload,i.cur_category=cur_category,i.page_number=e,i.is_admin=is_admin;var o=template("myGallery_inner",i);"replace"==a?(allViewPhoneData=t.picture_list,$("#myGallery").html(o)):(allViewPhoneData=allViewPhoneData.concat(t.picture_list),$("#myGallery").append(o)),$("img.lazy"+e).lazyload({effect:"fadeIn"}),$(".bk-main-r .gallery-more p").removeClass("hide"),$(".bk-main-r .gallery-more img").addClass("hide"),bindLi(),t.page_num>=t.total_page?bindLoadMore(!1,t.total_row):bindLoadMore(!0,t.total_row),page_number=t.page_num,page_size=t.page_size,total_page=t.total_page,total_row=t.total_row}},error:function(){var e={};e.success=!1,i.data=e;var t=template("myGallery_inner",i);$("#myGallery").html(t)}})}function getDownload(e,t,a,i,o){var r={file_id:e,file_ext:t,for_urlencoder_url:a,for_iso_url:i,url_code:encodeURI(o)};return dealDownpathFun(r)}function getSrc(e){var t=e.substring(0,2);return STATIC_IMAGE_PRE+url_path_img+t+"/"+e+"@200w_200h_100Q_1x.png"}function bindLi(){1==is_admin&&($("#myGallery li.gallery-item").unbind("mouseenter").bind("mouseenter",function(){$(this).find(".picture-op-wrap .photo-op-tip").removeClass("hide")}).unbind("mouseleave").bind("mouseleave",function(){$(this).find(".picture-op-wrap .photo-op-tip").addClass("hide"),$(this).find(".picture-op-wrap .photo-op-list").addClass("hide")}),$("#myGallery li.gallery-item .photo-op-tip").unbind("click").bind("click",function(){$(this).parent(".picture-op-wrap").find(".photo-op-list").toggleClass("hide")})),$("#myGallery input[name='pictureCheckbox']").unbind("click").bind("click",function(){$(this).attr("checked")?$(this).parents("li.gallery-item").addClass("checked"):$(this).parents("li.gallery-item").removeClass("checked")})}function bindLoadMore(e,t){$(window).off("scroll",bindScroll),$(".gallery-more").unbind("click"),e?($(".bk-main-r .gallery-more p").html("加载更多"),$(".gallery-more").bind("click",function(){scrollSetTimeout()}),$(window).scroll(bindScroll)):0==t?$(".bk-main-r .gallery-more p").html("暂无照片"):$(".bk-main-r .gallery-more p").html("没有照片了")}function bindScroll(){var e=$(this).scrollTop(),t=$(document).height();e+$(this).height()==t&&scrollSetTimeout()}function scrollSetTimeout(){page_number++,$(".bk-main-r .gallery-more p").addClass("hide"),$(".bk-main-r .gallery-more img").removeClass("hide"),getMyGallery(page_number,page_size,"append")}function comment(e){if(!$.cookie("person_id"))return art.dialog.alert("对不起，请登录后评论"),!1;comment_dialog=art.dialog({content:"<div class='comment' id='messageCommentAddOrEditMsg'></div>",width:350,lock:!0,icon:null,title:"发表评论",init:function(){messageCommentAddOrEditMsg=$("#messageCommentAddOrEditMsg").textarea({index:1,word_length:200})},close:function(){}},function(){var t=messageCommentAddOrEditMsg.textarea("value");if(t.length>100||0==t.length)return art.dialog.alert("请输入1-100个字"),!1;$.ajax({type:"POST",async:!1,data:{random_num:creatRandomNum(),person_id:$.cookie("person_id"),person_name:$.cookie("person_name"),identity_id:$.cookie("identity_id"),context:t,message_type:5,type_id:"spaceGallCom"+e+person_id+identity_id,parent_id:""},url:url_path_action+"/bbs/message/save",dataType:"json",success:function(t){t.success?$.ajax({type:"POST",async:!1,data:{business_type:business_type,picture_id:e,person_id:person_id,identity_id:identity_id},url:url_path_action+"/space/gallery/add_picture_comment_num",dataType:"json",success:function(e){e.success?dialogClose("评论成功！",2,150,""):dialogClose("评论失败！",2,150,"")},error:function(){dialogClose("评论失败！",2,150,"")}}):dialogClose("评论失败！",2,150,"")},error:function(){dialogClose("评论失败！",2,150,"")}})},function(){})}function addPraise(e,t){if(!$.cookie("person_id"))return art.dialog.alert("对不起，请登录后点赞"),!1;$.ajax({type:"POST",async:!1,data:{business_id:e,business_type:2,person_id:$.cookie("person_id"),identity_id:$.cookie("identity_id")},url:url_path_action+"/space/praise/add_praise_info",dataType:"json",success:function(a){a.success?(dialogClose("点赞成功！",2,150,""),$(t).removeClass("addPraise").addClass("cancelPraise"),$(t).removeAttr("onclick"),reloadPicturePraise(e,$(t).closest("li.gallery-item"))):dialogClose("点赞失败！",2,150,"")},error:function(){dialogClose("点赞失败！",2,150,"")}})}function cancelPraise(e,t){if(!$.cookie("person_id"))return art.dialog.alert("对不起，请登录后取消点赞"),!1;$.ajax({type:"POST",async:!1,data:{business_id:e,business_type:2,person_id:$.cookie("person_id"),identity_id:$.cookie("identity_id")},url:url_path_action+"/space/praise/cancel_praise_info",dataType:"json",success:function(a){a.success?(dialogClose("取消点赞成功！",2,200,""),$(t).removeClass("cancelPraise").addClass("addPraise"),$(t).attr("onclick","addPraise("+e+",this)"),reloadPicturePraise(e,$(t).closest("li.gallery-item"))):dialogClose("取消点赞失败！",2,200,"")},error:function(){dialogClose("取消点赞失败！",2,200,"")}})}function addDownLoadNum(e){$.ajax({type:"POST",async:!1,data:{business_type:business_type,picture_id:e,person_id:person_id,identity_id:identity_id},url:url_path_action_login+"/space/gallery/add_picture_download_num",dataType:"json",success:function(e){},error:function(){}})}function addBrowseNum(e){$.ajax({type:"POST",async:!1,data:{business_type:business_type,picture_id:e,person_id:person_id,identity_id:identity_id},url:url_path_action_login+"/space/gallery/add_picture_browse_num",dataType:"json",success:function(e){},error:function(){}})}function reloadPictureLi(e,t){$.ajax({type:"GET",async:!1,data:{random_num:creatRandomNum(),relation_id:e,business_type:business_type},url:url_path_action_login+"/space/gallery/get_picturebyid",dataType:"json",success:function(e){t.find(".name font").html(e.picture_name),t.find("a.name").attr("title",e.picture_name),t.find(".statistics .download").attr("title","下载数"+e.download_num).html(e.download_num),t.find(".statistics .comment").attr("title","评论数"+e.comment_num).html(e.comment_num),t.find(".statistics .preview").attr("title","预览数"+e.browse_num).html(e.browse_num)},error:function(){}})}function reloadPicturePraise(e,t){$.ajax({type:"GET",async:!1,data:{random_num:creatRandomNum(),business_id:e,business_type:2},url:url_path_action_login+"/space/praise/get_praisecount_byid",dataType:"json",success:function(e){t.find(".statistics .praise").attr("title","点赞数"+e.total).html(e.total)},error:function(){}})}function editPhoto(e,t){$(this).parents(".picture-op-wrap").find(".photo-op-list").addClass("hide");art.dialog({content:'<div class="row" style="margin:0px;width: 500px;line-height: 34px;"><div class="col-md-2">照片名称：</div><div class="col-md-10"><input name="" class="form-control" id="photo_name" type="text" value="'+$(t).closest("li.gallery-item").find(".gallery-detail .name font").text()+'"/></div></div>',fixed:!0,id:"Fm7",okVal:"确定",title:"修改照片名称",ok:function(){for(var a=$.trim(document.getElementById("photo_name").value),i=0,o=0;o<a.length;o++)a[o].match(/[^\x00-\xff]/gi),i+=1;if(0==i||i>100)return art.dialog.alert("请输入1-100个字！"),!1;$.ajax({type:"POST",url:url_path_action+"/space/gallery/edit_picture",async:!1,dataType:"json",data:{relation_id:e,picture_name:a},success:function(a){a.success?reloadPictureLi(e,$(t).closest("li.gallery-item")):art.dialog.alert(a.info)}})},cancel:!0})}function movePhotoToFolder(e,t,a){if(1==e){var i=$(".pictureCheckbox:checked");if(0==i.length)return dialogOk("请选择照片",200,""),!1;i.each(function(e){var o=jQuery.parseJSON($(i[e]).val());t+=0==e?""+o.relation_id:","+o.relation_id,a=o.folder_id})}var o=getGallery(a);if(o)art.dialog({content:'<div class="row" style="margin:0px;width: 500px;line-height: 34px;"><div class="col-md-2">移动到：</div><div class="col-md-10">'+o+"</div></div>",fixed:!0,id:"Fm7",okVal:"确定",title:"移动照片",ok:function(){var i=$("#galleryid").val();$.ajax({type:"POST",url:url_path_action+"/space/gallery/move_pictures",async:!1,dataType:"json",data:{relation_ids:t,from_folder_id:a,to_folder_id:i,business_type:business_type},success:function(t){t.success?(dialogClose("操作成功！",2,200,""),getGalleryStatistics(),getGalleryCategory(),window.scrollTo(0,0),getMyGallery("1",page_size,"replace"),1==e&&$(":checkbox").attr("checked",!1)):dialogOk(t.info,300,"")}})},cancel:!0});else art.dialog.alert("未发现其他相册！")}function getGallery(e){var t="";if($.ajax({type:"GET",url:url_path_action_login+"/space/gallery/get_galleryfolder?person_id="+person_id+"&identity_id="+identity_id+"&random_num="+creatRandomNum()+"&business_type="+business_type,async:!1,dataType:"json",success:function(a){if(a.success){var i=0;if((i=a.folder_list.length)>0)for(var o=0;o<i;o++)e!=a.folder_list[o].id&&(t=t+"<option value='"+a.folder_list[o].id+"'>"+a.folder_list[o].folder_name+"</option>")}else art.dialog.alert(a.info)}}),""==t)return!1;return"<select id='galleryid' class='form-control'>"+t+"</select>"}function removePhoto(e,t,a){var i=0;if(1==e){var o=$(".pictureCheckbox:checked");if(0==(i=o.length))return dialogOk("请选择照片",200,""),!1;o.each(function(e){var i=jQuery.parseJSON($(o[e]).val());t+=0==e?""+i.relation_id:","+i.relation_id,a=i.folder_id})}else i=1;art.dialog.confirm(1==i?"确定要删除该照片吗?":"确定要删除这些照片吗?",function(){$.ajax({type:"POST",url:url_path_action+"/space/gallery/delete_picture",async:!1,dataType:"json",data:{relation_ids:t,folder_id:a,person_id:person_id,identity_id:identity_id,business_type:business_type},success:function(t){t.success?(dialogClose("操作成功！",2,200,""),getGalleryStatistics(),getGalleryCategory(),window.scrollTo(0,0),getMyGallery("1",page_size,"replace"),1==e&&$(":checkbox").attr("checked",!1)):dialogOk(t.info,300,"")}})},function(){})}function checkAll(e){$(e).attr("checked")?($("#myGallery input[name='pictureCheckbox']").attr("checked",!0),$("#myGallery .gallery-item").addClass("checked")):($("input[name='pictureCheckbox']").attr("checked",!1),$("#myGallery .gallery-item").removeClass("checked"))}function doupload(){tb_show("上传照片","upload_photo.html?folderid="+cur_category+"&id="+person_id+"&identity_id="+identity_id+"&business_type="+business_type+"&is_admin="+is_admin+"&TB_iframe=true&height=380&width=700","thickbox")}function tb_remove_after(){getGalleryCategory(function(){getGalleryStatistics()}),$(":checkbox").attr("checked",!1),getMyGallery(1,page_size,"replace")}var person_id,identity_id,page_number=1,business_type="2",page_size=20,total_page=1,cur_category="",total_row,is_admin=0,is_super=0,is_member=0,is_login=0,is_exist=0,allViewPhoneData=[],Gallery={};window.onload=function(){if(null==GetQueryString("orgid")||null==GetQueryString("iid"))return art.dialog.alert("未检测到访问的群组信息！"),!1;person_id=GetQueryString("orgid"),identity_id=GetQueryString("iid"),person_id==$.cookie("person_id")&&identity_id==$.cookie("identity_id")?visit_to=3:$.cookie("person_id")?visit_to=2:visit_to=1;var e={};e.is_admin=is_admin,e.is_member=is_member,$("#mainblog").html(template("mainblog_inner",e)),null!=cur_category&&""!=cur_category?($(".batch-op .batch-move").show(),$(".batch-op .batch-remove").show(),$(".batch-op .checkbox").show()):($(".batch-op .batch-move").hide(),$(".batch-op .batch-remove").hide(),$(".batch-op .checkbox").hide()),getGalleryCategory(function(){getGalleryStatistics()}),getMyGallery(page_number,page_size,"replace");$(".fancybox").fancybox({maxWidth:1200,minWidth:600,beforeLoad:function(){return this.width=1200,this.height=600,!0},afterShow:function(){$(".fancybox-next").hide(),$(".fancybox-prev").hide(),$(this.content)[0].contentWindow.loadImage()}});Gallery={getGalleryStatistics:getGalleryStatistics,getGalleryCategory:getGalleryCategory,getMyGallery:getMyGallery,getParamValue:function(e){switch(e){case"person_id":return person_id;case"identity_id":return identity_id;case"page_number":return page_number;case"page_size":return page_size;case"business_type":return business_type;case"total_page":return total_page;case"total_row":return total_row;case"cur_category":return cur_category;case"allViewPhoneData":return allViewPhoneData;case"visit_to":return visit_to}}}};var dia,comment_dialog,messageCommentAddOrEditMsg;