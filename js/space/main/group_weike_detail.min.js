function loadMainNav(){var e=template("mainGroupNavInner",{});$("#groupMain").html(e)}function getDetail(){$.ajax({async:!1,url:url_path_html+"/yx/moke/getMokeById?random_num="+Math.random(),type:"post",data:{moke_id:moke_id},dataType:"json",success:function(e){e.success&&(detail=e,$("#mk_title").text(e.title),$("#mk_person_name").text(e.person_name),$("#mk_stage_subject").text(e.stage_name+e.subject_name),$("#zhuanjia_name").text(group_data.CREATOR_NAME),initStatus(e.status))}})}function initStatus(e){1==e?(initKeli(1),1==is_admin&&($("#fujianBtn_1").show(),$("#yijianBtn_1").show(),$("#comment_1").removeAttr("disabled"),$("#zxzhdiao_1").show()),$.cookie("person_id")==detail.person_id&&($("#changeBtn_1").show(),$("#zxzhdiao_1").show())):2==e?(initKeli(1),initKeli(2),$("#fujianBtn_1").hide(),$("#yijianBtn_1").hide(),$("#changeBtn_1").hide(),1==is_admin&&($("#fujianBtn_2").show(),$("#yijianBtn_2").show(),$("#comment_2").removeAttr("disabled"),$("#zxzhdiao_2").show()),$.cookie("person_id")==detail.person_id&&($("#changeBtn_2").show(),$("#zxzhdiao_2").show())):3==e?(initKeli(1),initKeli(2),initKeli(3),$("#fujianBtn_1").hide(),$("#yijianBtn_1").hide(),$("#changeBtn_1").hide(),$("#fujianBtn_2").hide(),$("#yijianBtn_2").hide(),$("#changeBtn_2").hide(),1==is_admin&&($("#fujianBtn_3").show(),$("#yijianBtn_3").show(),$("#comment_3").removeAttr("disabled"),$("#changeBtn_3").show(),$("#zxzhdiao_3").show()),$.cookie("person_id")==detail.person_id&&$("#zxzhdiao_3").show()):4==e&&(initKeli(1),initKeli(2),initKeli(3),$("#changeBtn_3").attr("disabled","disabled"))}function initKeli(e,t){var i=template("tab_template",{type:e});$("#tab_"+e).html(i),initResource(e),getZhidaoyijian(e)}function initResource(e,t){1==e?(showResourceList(1),showResourceList(2),showResourceList(3),showResourceList(4),showResourceList(5)):2==e?(showResourceList(6,t),showResourceList(7,t),showResourceList(8,t),showResourceList(9,t),showResourceList(10,t)):3==e&&(showResourceList(11,t),showResourceList(12,t),showResourceList(13,t),showResourceList(14,t),showResourceList(15,t),showResourceList(16,t),showResourceList(17,t))}function showResourceList(e,t){var i=url_path_html+"/space/ypt/getResourceAll?t="+Math.random();$.ajax({url:i,type:"post",data:{res_type:51,pageNumber:1,pageSize:100,rtype:0,beike_type:e,view:moke_id,sort_num:2},dataType:"json",success:function(i){if(i.success)if(null!=i.list&&i.list.length>0){i=addServerUrlToJson(i),upDataToJson(i,1),beforeRender(i),t&&null!=$.cookie("person_id")&&$.cookie("person_id")==detail.person_id?i.is_mine=1:i.is_mine=0,i.reType=e,i.toJSONString=toJsonString;var o=template.render("resource_list_template",i);$("#resource_list_"+e).html(o)}else $("#resource_list_"+e).parent("li.boxli").hide()}})}function toJsonString(e){return Base64.encode(JSON.stringify(e))}function changeBack(e){setTimeout(function(){showResourceList(e,!0)},3e3)}function getZhidaoyijian(e){var t="yx_comment_51_"+moke_id+"_"+e;$.ajax({type:"GET",async:!0,data:{random_num:creatRandomNum(),pageNumber:1,pageSize:pageSize,sort:1,type_id:t,message_type:2},url:url_path_html+"/bbs/topic/view",dataType:"json",success:function(t){t.success&&t.reply_list.length>0&&$("#comment_"+e).val(t.reply_list[0].content)}})}function saveZhidaoyijian(e){var t="yx_comment_51_"+moke_id+"_"+e,i=$("#comment_"+e).val();$.ajax({type:"post",async:!1,data:{person_id:$.cookie("person_id"),person_name:$.cookie("person_name"),identity_id:$.cookie("identity_id"),context:i,message_type:2,type_id:t,parent_id:""},url:url_path_html+"/ypt/bbs/message/save",dataType:"json",success:function(t){dialogClose("已提交成功！",2,200),$("#yijianBtn_"+e).attr("disabled","disabled"),$("#comment_"+e).attr("disabled","disabled")}})}function uploadResource(e){var t=0;t=1==e?2:2==e?3:3==e?13:17,hj_type=e;var i=url_path_html+"/yx/html/resource/uploadYxResource.html";i+="?service_type=51",i+="&service_id="+moke_id,i+="&hj_id="+e,i+="&res_type=14",i+="&stage_id="+detail.stage_id,i+="&subject_id="+detail.subject_id,i+="&scheme_id="+detail.scheme_id,i+="&structure_id="+detail.structure_id,i+="&appType_id="+t,i+="&TB_iframe=true",i+="&height=450",i+="&width=720",tb_show("上传资源",i,"thickbox")}function tb_remove(){return $("#TB_imageOff").unbind("click"),$("#TB_closeWindowButton").unbind("click"),$("#TB_window").fadeOut("200",function(){$("#TB_iframeContent").remove(),$("#TB_window,#TB_overlay,#TB_HideSelect").trigger("unload").unbind().remove()}),$("#TB_load").remove(),document.onkeydown="",document.onkeyup="",showResourceList(hj_type),!1}function changeResource(e){if(4==(e+=1))submitMoke(4);else{var t='<div><button class="btn btn-default btn-sm" onclick="followInitial('+e+', this)">延用</button></div><div id="otherInfoPannel" style="width:400px">';t+='<div class="form-group">',t+='<span>教学设计(必填)<span style="color:red">*</span>：</span>',t+='<button class="btn btn-primary btn-sm ml10" onclick="uploadResource('+(2==e?6:11)+')" type="button">上传</button>',t+='<div id="resource_list_'+(2==e?6:11)+'"></div>',t+="</div>",t+='<div class="form-group">',t+='<span>教学课件(必填)<span style="color:red">*</span>：</span>',t+='<button class="btn btn-primary btn-sm ml10" onclick="uploadResource('+(2==e?7:12)+')" type="button">上传</button>',t+='<div id="resource_list_'+(2==e?7:12)+'"></div>',t+="</div>",t+='<div class="form-group">',t+="<span>教学素材：</span>",t+='<button class="btn btn-primary btn-sm ml10" onclick="uploadResource('+(2==e?8:13)+')" type="button">上传</button>',t+='<div id="resource_list_'+(2==e?8:13)+'"></div>',t+="</div>",t+='<div class="form-group">',t+=3==e?'<span>课堂实录(必填)<span style="color:red">*</span>：</span>':"<span>课堂实录：</span>",t+='<button class="btn btn-primary btn-sm ml10" onclick="uploadResource('+(2==e?9:14)+')" type="button">上传</button>',t+='<div id="resource_list_'+(2==e?9:14)+'"></div>',t+="</div>",3==e&&(t+='<div class="form-group">',t+='<span>教学反思<span style="color:red">*</span>：</span>',t+='<button class="btn btn-primary btn-sm ml10" onclick="uploadResource(16)" type="button">上传</button>',t+='<div id="resource_list_16"></div>',t+="</div>",t+='<div class="form-group">',t+="<span>设计思路：</span>",t+='<button class="btn btn-primary btn-sm ml10" onclick="uploadResource(17)" type="button">上传</button>',t+='<div id="resource_list_17"></div>',t+="</div>"),t+="</div>",art.dialog({height:300,width:400,zIndex:10,fixed:!0,title:"修改课例",lock:!0,content:t,init:function(){initResource(e,!0)},button:[{name:"保存",callback:function(){return dialogClose("保存成功！",2,200),!0},focus:!0},{name:"保存并提交",callback:function(){var t=checkResource(e);return t&&(t=submitMoke(e)),t}}]})}}function followInitial(e,t){$(t).attr("disabled",!0);for(var i=2==e?1:6,o=$("#collapse"+(e-1)),n=$("#otherInfoPannel"),s=o.find("#resource_list_"+i++).find(".fj-overflow"),a=n.find("#resource_list_"+(i+4)).find(".fj-overflow"),l="",r=0;r<s.length;r++)isInModifyResource(dealSelectedResourceData($(s[r]).attr("id")).resource_id_int,a)?l+='<div class="checkbox follow-text"><label><input id="'+$(s[r]).attr("id")+'" checked="checked" disabled="disabled" type="checkbox" name="design" value="'+s[r].innerText+'">'+s[r].innerText+"</label></div>":l+='<div class="checkbox follow-text"><label><input id="'+$(s[r]).attr("id")+'" type="checkbox" name="design" value="'+s[r].innerText+'">'+s[r].innerText+"</label></div>";for(var d=o.find("#resource_list_"+i++).find(".fj-overflow"),c=n.find("#resource_list_"+(i+4)).find(".fj-overflow"),u="",r=0;r<d.length;r++)isInModifyResource(dealSelectedResourceData($(d).attr("id")).resource_id_int,c)?u+='<div class="checkbox follow-text"><label><input id="'+$(d[r]).attr("id")+'" checked="checked" disabled="disabled" type="checkbox" name="courseware" value="'+d[r].innerText+'">'+d[r].innerText+"</label></div>":u+='<div class="checkbox follow-text"><label><input id="'+$(d[r]).attr("id")+'" type="checkbox" name="courseware" value="'+d[r].innerText+'">'+d[r].innerText+"</label></div>";for(var _=o.find("#resource_list_"+i++).find(".fj-overflow"),p=n.find("#resource_list_"+(i+4)).find(".fj-overflow"),h="",r=0;r<_.length;r++)isInModifyResource(dealSelectedResourceData($(_).attr("id")).resource_id_int),h+=p?'<div class="checkbox follow-text"><label><input id="'+$(_[r]).attr("id")+'" type="checkbox" checked="checked" disabled="disabled" name="resource" value="'+_[r].innerText+'">'+_[r].innerText+"</label></div>":'<div class="checkbox follow-text"><label><input id="'+$(_[r]).attr("id")+'" type="checkbox" name="resource" value="'+_[r].innerText+'">'+_[r].innerText+"</label></div>";for(var f=o.find("#resource_list_"+i++).find(".fj-overflow"),m=n.find("#resource_list_"+(i+4)).find(".fj-overflow"),v="",r=0;r<f.length;r++)isInModifyResource(dealSelectedResourceData($(f).attr("id")).resource_id_int,m)?v+='<div class="checkbox follow-text"><label><input id="'+$(f[r]).attr("id")+'" type="checkbox" checked="checked" disabled="disabled" name="video" value="'+f[r].innerText+'">'+f[r].innerText+"</label></div>":v+='<div class="checkbox follow-text"><label><input id="'+$(f[r]).attr("id")+'" type="checkbox" name="video" value="'+f[r].innerText+'">'+f[r].innerText+"</label></div>";var b='<div class="checkbox" onclick="selectCheckbox(this)" ><label><input  type="checkbox" name="all" value="">全选</label></div><ul class="follow-wrapper" id="follow-resource-list"><li class="boxli"><div class="checkbox" onclick="selectCheckbox(this)"><label><input type="checkbox" name="design"  value=""/>教学设计：</label></div><div id="resource_follow_'+i+++'">'+l+'</div><div class="clear"></div></li><li class="boxli"><div class="checkbox" onclick="selectCheckbox(this)"><label><input type="checkbox" name="courseware" value=""/>教学课件：</label></div><div id="resource_follow_'+i+++'">'+u+'</div><div class="clear"></div></li><li class="boxli"><div class="checkbox" onclick="selectCheckbox(this)"><label><input type="checkbox" name="resource" value=""/>教学素材：</label></div><div id="resource_follow_'+i+++'">'+h+'</div><div class="clear"></div></li></li><li class="boxli"><div class="checkbox" onclick="selectCheckbox(this)"><label><input type="checkbox" name="video"  value=""/>课堂实录：</label></div><div id="resource_follow_'+i+++'">'+v+'</div><div class="clear"></div></li>';art.dialog({height:350,width:450,zIndex:20,fixed:!0,title:"延用资源列表",lock:!0,content:b,init:function(){for(var e=$(".aui_state_lock"),t=[],i=0;i<e.length;i++)t.push($(e[i]).css("z-index"));var o=Math.max.apply(null,t);$(".aui_state_focus").zIndex(o+5)},close:function(){$(this).remove(),$(t).attr("disabled",!1)},button:[{name:"确定",callback:function(){var i=showSelectedFollowResource(e);if(0==i.getSelectedFollowResource().length)return $(t).attr("disabled",!1),void $(this).remove();$.ajax({type:"POST",url:url_path_html+"/yx/moke/addFollowResource",dataType:"json",data:{ResourceData:JSON.stringify(i.getSelectedFollowResource())},success:function(e){return e.success?(i.appendSelectedFollowResource(e.data),dialogClose("保存成功！",2,200),$(this).remove(),$(t).attr("disabled",!1),!0):(dialogClose("保存失败！",2,200),$(t).attr("disabled",!1),!1)}})},focus:!0}]})}function showSelectedFollowResource(e){for(var t=$("#follow-resource-list").find("input[name='design']"),i=$("#follow-resource-list").find("input[name='courseware']"),o=$("#follow-resource-list").find("input[name='resource']"),n=$("#follow-resource-list").find("input[name='video']"),s=[],a=[],l=0;l<t.length;l++)"disabled"!=$(t[l]).attr("disabled")&&$(t[l]).attr("checked")&&$(t[l]).val()&&s.push(dealSelectedResourceData($(t[l]).attr("id"),a));for(var r=[],l=0;l<i.length;l++)"disabled"!=$(i[l]).attr("disabled")&&$(i[l]).attr("checked")&&$(i[l]).val()&&r.push(dealSelectedResourceData($(i[l]).attr("id"),a));for(var d=[],l=0;l<o.length;l++)"disabled"!=$(o[l]).attr("disabled")&&$(o[l]).attr("checked")&&$(o[l]).val()&&d.push(dealSelectedResourceData($(o[l]).attr("id"),a));for(var c=[],l=0;l<n.length;l++)"disabled"!=$(n[l]).attr("disabled")&&$(n[l]).attr("checked")&&$(n[l]).val()&&c.push(dealSelectedResourceData($(n[l]).attr("id"),a));return{getSelectedFollowResource:function(){return a},appendSelectedFollowResource:function(t){var i=$("#otherInfoPannel"),o=2==e?6:11,n=0;for(n=0;n<s.length;n++)s[n].iid=t[s[n].resource_id_int+"_"+s[n].reType];var a=template.render("resource_list_template",{list:s,is_mine:1,toJSONString:toJsonString}),l=$(i).find("#resource_list_"+o++);for($(l).append(a),n=0;n<r.length;n++)r[n].iid=t[r[n].resource_id_int+"_"+r[n].reType];var u=template("resource_list_template",{list:r,is_mine:1,toJSONString:toJsonString}),_=$(i).find("#resource_list_"+o++);for($(_).append(u),n=0;n<d.length;n++)d[n].iid=t[d[n].resource_id_int+"_"+d[n].reType];var p=template("resource_list_template",{list:d,is_mine:1,toJSONString:toJsonString}),h=$(i).find("#resource_list_"+o++);for($(h).append(p),n=0;n<c.length;n++)c[n].iid=t[c[n].resource_id_int+"_"+c[n].reType];var f=template("resource_list_template",{list:c,is_mine:1,toJSONString:toJsonString}),m=$(i).find("#resource_list_"+o++);$(m).append(f)}}}function dealSelectedResourceData(e,t){var i=e.split("_"),o=Base64.decode(i[0]),n=parseInt(i[1])+5,s=JSON.parse(o);return s.reType=n,t&&t.push({service_type:"51",service_id:moke_id,resource_id_int:s.resource_id_int,bk_type:n}),s}function selectCheckbox(e){var t=$(e).find("input[type='checkbox']"),i=$(t).attr("checked"),o=$(t).attr("name");if("all"==o){n=$("#follow-resource-list").find("input[type='checkbox']").not("input[disabled='disabled']");i?$(n).attr("checked",!0):$(n).removeAttr("checked")}else{var n=$("#follow-resource-list").find("input[name='"+o+"']").not("input[disabled='disabled']");i?$(n).attr("checked",!0):$(n).removeAttr("checked")}}function isInModifyResource(e,t){for(var i=0;i<t.length;i++)if(dealSelectedResourceData($(t[i]).attr("id")).resource_id_int==e)return!0;return!1}function submitMoke(e){var t=!1;return $.ajax({type:"post",async:!1,data:{status:e,moke_id:moke_id},url:url_path_html+"/yx/moke/submitStatusMokeTeam?t="+Math.random(),dataType:"json",success:function(i){i.success&&(dialogClose("提交成功！",2,200),initStatus(e),t=!0,getGroupMessage(function(e){if(e.success){var t={person_id:$.cookie("person_id"),identity_id:$.cookie("identity_id"),platform_type:1,business_type:301,relatived_id:detail.moke_id,e_relatived_id:"",r_person_id:e.CREATE_ID,r_identity_id:e.IDENTITY_ID,operation_content:$.cookie("person_name")+"更新了磨课内容",norepeat_ts:(new Date).getTime()};$.ajax({type:"post",url:url_path_html+"/credit/writeToQueue",data:t,dataType:"json",success:function(e){console.info("添加消息队列",e)}})}}))}}),t}function getGroupMessage(e){$.ajax({type:"post",url:url_path_html+"/group/queryGroupById?random_num="+Math.random(),data:{groupId:detail.team_id},dataType:"json",success:function(t){e(t)}})}function checkResource(e){if(2==e){if(0==$("#resource_list_6 div").length)return dialogClose("未上传教学设计！",2,200),!1;if(0==$("#resource_list_7 div").length)return dialogClose("未上传教学课件！",2,200),!1}else if(3==e){if(0==$("#resource_list_11 div").length)return dialogClose("未上传教学设计！",2,200),!1;if(0==$("#resource_list_12 div").length)return dialogClose("未上传教学课件！",2,200),!1;if(0==$("#resource_list_16 div").length)return dialogClose("未上传教学反思！",2,200),!1;if(0==$("#resource_list_14 div").length)return dialogClose("未上传课堂实录！",2,200),!1}return!0}function openMeeting(){if(undefined!=$.cookie("person_id")&&"null"!=$.cookie("person_id")&&5==$.cookie("identity_id")){var e=0;$.cookie("person_id")==group_data.CREATOR_ID?e=1:$.cookie("person_id")==detail.person_id&&(e=2)}var t={hd_confid:detail.moke_confid,con_pass:detail.con_pass,show_name:$.cookie("person_name"),moke_use:1};if(0==e)return void initMeetingByPass();1==e&&(t.main_pass=0),intoMeeting(t)}function initMeetingByPass(e){art.dialog({content:'<div style="text-align:center"><input id="con_pass_btn"/></div>',width:340,title:"非组内成员，请输入密码进入视频讨论",close:function(){return!0},ok:function(){return""==$.trim($("#con_pass_btn").val())?(dialogOk("活动密码不能为空"),$("#con_pass_btn").val(""),!1):$("#con_pass_btn").val()==detail.con_pass?(intoMeeting({hd_confid:detail.hd_confid,con_pass:detail.con_pass,show_name:$.cookie("person_name")}),!0):(dialogOk("密码输入错误"),!1)}})}function intoMeeting(e){e.hd_id=detail.obj_info_id,e.hd_name=detail.title,$.ajax({url:url_path_html+"/yx/hd/getJoinMeetingInfo",type:"POST",async:!1,data:e,dataType:"json",success:function(e){if(e.success){var t=url_path_html+"/yx/html/hd/joinMeeting.html";t+="?conf="+Base64.encode(e.conf),t+="&url="+e.url,ddialog=art.dialog.open(t,{id:"closeDialog5s",title:"进入活动，请稍后...",width:400,zIndex:9999,lock:!0})}}})}var struc,moke_id;$(function(){if(moke_id=GetQueryString("id"),!org_id||!moke_id)return art.dialog.alert("非法请求地址!"),!1;$(".fancybox").fancybox({openEffect:"none",closeEffect:"none",afterShow:function(){var e=$(".fancybox")[this.index],t='<div class="fancybox-title fancybox-title-outside-wrap-tool">'+$(e).attr("title")+"</div>";$(t).appendTo(this.wrap)}}),loadMainNav(),getDetail()});var detail=null,hj_type=1,ddialog=null;