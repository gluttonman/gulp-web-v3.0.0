var Gallery=function(){function e(){tb_show("上传照片","upload_photo.html?folderid="+I+"&id="+j+"&identity_id="+G+"&business_type="+R+"&visit_to="+P+"&TB_iframe=true&height=380&width=700","thickbox")}function t(){var e={};$.ajax({type:"GET",async:!0,data:{random_num:creatRandomNum(),person_id:j,identity_id:G},url:url_path_action_login+"/space/gallery/get_stat_num",dataType:"json",success:function(t){e.data=t;var a=template("galleryStatistics_inner",e);$("#galleryStatistics").html(a)},error:function(){var t={};t.success=!1,e.data=t;var a=template("galleryStatistics_inner",e);$("#galleryStatistics").html(a)}})}function a(){var e={};$.ajax({type:"GET",async:!0,data:{random_num:creatRandomNum(),person_id:j,identity_id:G,business_type:R},url:url_path_action_login+"/space/gallery/get_galleryfolder",dataType:"json",success:function(t){e.data=t;var a=template("galleryCategory_inner",e);$("#galleryCategory").html(a),$("#galleryCategory li").removeClass("active"),$("#category_"+I).addClass("active"),i()},error:function(){var t={};t.success=!1,e.data=t;var a=template("galleryCategory_inner",e);$("#galleryCategory").html(a)}})}function i(){$("#galleryCategory li").click(function(){$("#galleryCategory li").removeClass("active"),$(this).addClass("active"),c(N=1,A,"replace"),$(":checkbox").attr("checked",!1),null!=(I=$("#galleryCategory li.active input").val())&&""!=I?($(".batch-op .batch-move").show(),$(".batch-op .batch-remove").show(),$(".batch-op .checkbox").show()):($(".batch-op .batch-move").hide(),$(".batch-op .batch-remove").hide(),$(".batch-op .checkbox").hide())})}function o(){n(),M=art.dialog({content:$("#galleryCategoryManageDialog").html(),width:700,lock:!0,icon:null,title:"相册管理",close:function(){},ok:!0})}function n(){$("#galleryCategoryManageDialog table tbody").empty(),$.ajax({type:"GET",async:!1,data:{random_num:creatRandomNum(),person_id:j,identity_id:G,business_type:R},url:url_path_action_login+"/space/gallery/get_galleryfolder",dataType:"json",success:function(e){if(e.success){var t={};t.data=e;var a=template("galleryCategoryManage_inner",t);$("#galleryCategoryManageDialog table tbody").html(a)}},error:function(){var e={};e.success=!1;var t={};t.data=e;var a=template("galleryCategoryManage_inner",t);$("#galleryCategoryManageDialog table tbody").html(a)}})}function l(e,t,i){var o=null;art.dialog({title:0==e?"增加相册":"修改相册",content:"<div id='editSortDiv' style='width:400px;'><table width='100%' class='table table-info'><tbody><tr><td scope='row' width='72'>相册名称<br/>&nbsp;</td><td colspan='3'><div id='editSortTitle'></div></tr></tbody></table></div>",fixed:!0,lock:!0,width:400,init:function(){o=$("#editSortTitle").input({index:3,placeholder:"请输入相册名称",maxCount:20,showType:1,width:275,onCheck:function(){""==o.input("value")&&o.input("setTips","相册名称不能为空")}}),1==e&&o.input("setVal",$(t).closest("tr").find(".title").html()),$("#editSortTitle").val($.trim($("#editSortTitle").val()).substring(0,20)),$("#editSortHid").text(20-$("#editSortTitle").val().length),$("#editSortTitle").bind("keyup",function(){$("#editSortTitle").val($.trim($("#editSortTitle").val()).substring(0,20)),$("#editSortHid").text(20-$("#editSortTitle").val().length)}).bind("paste",function(){$("#editSortTitle").val($.trim($("#editSortTitle").val()).substring(0,20)),$("#editSortHid").text(20-$("#editSortTitle").val().length)})}},function(){var t=o.input("value");return 0==t.length?(art.dialog.alert("请输入相册名称！"),!1):t.length>20?(art.dialog.alert("相册名称过长！"),!1):void(0==e?$.ajax({type:"POST",async:!1,data:{person_id:j,identity_id:G,folder_name:t,business_type:R,is_private:"0"},url:url_path_action+"/space/gallery/create_galleryfolder",dataType:"json",success:function(e){e.success?(dialogClose("保存成功！",2,150,""),n(),M.content($("#galleryCategoryManageDialog").html()),a()):dialogClose("保存失败！",2,150,"")},error:function(){dialogClose("保存失败！",2,150,"")}}):$.ajax({type:"POST",async:!1,data:{folder_name:t,folder_id:i},url:url_path_action+"/space/gallery/edit_galleryfolder",dataType:"json",success:function(e){e.success?(dialogClose("修改成功！",2,150,""),n(),M.content($("#galleryCategoryManageDialog").html()),a()):dialogClose("修改失败！",2,150,"")},error:function(){dialogClose("修改失败！",2,150,"")}}))},function(){})}function r(e,t){art.dialog({title:"删除相册",content:'确定删除"'+$(e).closest("tr").find(".title").html()+'"这个相册吗?',fixed:!0,lock:!0,icon:"question"},function(){$.ajax({type:"POST",async:!1,data:{folder_id:t,person_id:j,identity_id:G,business_type:R},url:url_path_action+"/space/gallery/delete_galleryfolder",dataType:"json",success:function(e){e.success?(dialogClose("删除成功！",2,150,""),n(),M.content($("#galleryCategoryManageDialog").html()),a()):art.dialog.alert("删除失败！"+e.info)},error:function(){art.dialog.alert("删除失败！"+data.info)}})},function(){})}function c(e,t,a){var i={};$.ajax({type:"GET",async:!0,data:{random_num:creatRandomNum(),folder_id:$("#galleryCategory li.active input").val(),business_type:R,identity_id:G,person_id:j,page_num:e,page_size:t,l_person_id:$.cookie("person_id"),l_identity_id:$.cookie("identity_id")},url:url_path_action_login+"/space/gallery/get_picture",dataType:"json",success:function(t){if(t.success){i.data=t,i.getSrc=d,i.getDownload=s,i.visit_to=P,i.cur_category=I,i.page_number=e;var o=template("myGallery_inner",i);"replace"==a?(z=t.picture_list,$("#myGallery").html(o)):(z=z.concat(t.picture_list),$("#myGallery").append(o)),$("img.lazy"+e).lazyload({effect:"fadeIn"}),$(".bk-main-r .gallery-more p").removeClass("hide"),$(".bk-main-r .gallery-more img").addClass("hide"),u(),t.page_num>=t.total_page?p(!1,t.total_row):p(!0,t.total_row),N=t.page_num,A=t.page_size,Q=t.total_page,O=t.total_row}},error:function(){var e={};e.success=!1,i.data=e;var t=template("myGallery_inner",i);$("#myGallery").html(t)}})}function s(e,t,a,i,o){var n={file_id:e,file_ext:t,for_urlencoder_url:a,for_iso_url:i,url_code:encodeURI(o)};return dealDownpathFun(n)}function d(e){var t=e.substring(0,2);return STATIC_IMAGE_PRE+url_path_img+t+"/"+e+"@200w_200h_100Q_1x.png"}function u(){"3"==P&&($("#myGallery li.gallery-item").unbind("mouseenter").bind("mouseenter",function(){$(this).find(".picture-op-wrap .photo-op-tip").removeClass("hide")}).unbind("mouseleave").bind("mouseleave",function(){$(this).find(".picture-op-wrap .photo-op-tip").addClass("hide"),$(this).find(".picture-op-wrap .photo-op-list").addClass("hide")}),$("#myGallery li.gallery-item .photo-op-tip").unbind("click").bind("click",function(){$(this).parent(".picture-op-wrap").find(".photo-op-list").toggleClass("hide")})),$("#myGallery input[name='pictureCheckbox']").unbind("click").bind("click",function(){$(this).attr("checked")?$(this).parents("li.gallery-item").addClass("checked"):$(this).parents("li.gallery-item").removeClass("checked")})}function p(e,t){$(window).off("scroll",_),$(".gallery-more").unbind("click"),e?($(".bk-main-r .gallery-more p").html("加载更多"),$(".gallery-more").bind("click",function(){y()}),$(window).scroll(_)):0==t?$(".bk-main-r .gallery-more p").html("暂无照片"):$(".bk-main-r .gallery-more p").html("没有照片了")}function _(){var e=$(this).scrollTop(),t=$(document).height();e+$(this).height()==t&&y()}function y(){N++,$(".bk-main-r .gallery-more p").addClass("hide"),$(".bk-main-r .gallery-more img").removeClass("hide"),c(N,A,"append")}function g(e){if(!$.cookie("person_id"))return art.dialog.alert("对不起，请登录后评论"),!1;D=art.dialog({content:"<div class='comment' id='messageCommentAddOrEditMsg'></div>",width:350,lock:!0,icon:null,title:"发表评论",init:function(){E=$("#messageCommentAddOrEditMsg").textarea({index:1,word_length:200})},close:function(){}},function(){var t=E.textarea("value");if(t.length>100||0==t.length)return art.dialog.alert("请输入1-100个字"),!1;$.ajax({type:"POST",async:!1,data:{random_num:creatRandomNum(),person_id:$.cookie("person_id"),person_name:$.cookie("person_name"),identity_id:$.cookie("identity_id"),context:t,message_type:5,type_id:"spaceGallCom"+e+j+G,parent_id:""},url:url_path_action+"/bbs/message/save",dataType:"json",success:function(t){t.success?$.ajax({type:"POST",async:!1,data:{business_type:R,picture_id:e,person_id:j,identity_id:G},url:url_path_action+"/space/gallery/add_picture_comment_num",dataType:"json",success:function(e){e.success?dialogClose("评论成功！",2,150,""):dialogClose("评论失败！",2,150,"")},error:function(){dialogClose("评论失败！",2,150,"")}}):dialogClose("评论失败！",2,150,"")},error:function(){dialogClose("评论失败！",2,150,"")}})},function(){})}function m(e,t){if(!$.cookie("person_id"))return art.dialog.alert("对不起，请登录后点赞"),!1;$.ajax({type:"POST",async:!1,data:{business_id:e,business_type:2,person_id:$.cookie("person_id"),identity_id:$.cookie("identity_id")},url:url_path_action+"/space/praise/add_praise_info",dataType:"json",success:function(a){a.success?(dialogClose("点赞成功！",2,150,""),$(t).removeClass("addPraise").addClass("cancelPraise"),$(t).removeAttr("onclick","cancelPraise("+e+",this)"),v(e,$(t).closest("li.gallery-item"))):dialogClose("点赞失败！",2,150,"")},error:function(){dialogClose("点赞失败！",2,150,"")}})}function h(e){$.ajax({type:"POST",async:!1,data:{business_type:R,picture_id:e,person_id:j,identity_id:G},url:url_path_action_login+"/space/gallery/add_picture_download_num",dataType:"json",success:function(e){},error:function(){}})}function f(e,t){$.ajax({type:"GET",async:!1,data:{random_num:creatRandomNum(),relation_id:e,business_type:R},url:url_path_action_login+"/space/gallery/get_picturebyid",dataType:"json",success:function(e){t.find(".name font").html(e.picture_name),t.find("a.name").attr("title",e.picture_name),t.find(".statistics .download").attr("title","下载数"+e.download_num).html(e.download_num),t.find(".statistics .comment").attr("title","评论数"+e.comment_num).html(e.comment_num),t.find(".statistics .preview").attr("title","预览数"+e.browse_num).html(e.browse_num)},error:function(){}})}function v(e,t){$.ajax({type:"GET",async:!1,data:{random_num:creatRandomNum(),business_id:e,business_type:2},url:url_path_action_login+"/space/praise/get_praisecount_byid",dataType:"json",success:function(e){t.find(".statistics .praise").attr("title","点赞数"+e.total).html(e.total)},error:function(){}})}function b(e,t){$(this).parents(".picture-op-wrap").find(".photo-op-list").addClass("hide");art.dialog({content:'<div class="row" style="margin:0px;width: 500px;line-height: 34px;"><div class="col-md-2">照片名称：</div><div class="col-md-10"><input name="" class="form-control" id="photo_name" type="text" value="'+$(t).closest("li.gallery-item").find(".gallery-detail .name font").text()+'"/></div></div>',fixed:!0,id:"Fm7",okVal:"确定",title:"修改照片名称",ok:function(){for(var a=$.trim(document.getElementById("photo_name").value),i=0,o=0;o<a.length;o++)a[o].match(/[^\x00-\xff]/gi),i+=1;if(0==i||i>100)return art.dialog.alert("请输入1-100个字！"),!1;$.ajax({type:"POST",url:url_path_action+"/space/gallery/edit_picture",async:!1,dataType:"json",data:{relation_id:e,picture_name:a},success:function(a){a.success?f(e,$(t).closest("li.gallery-item")):art.dialog.alert(a.info)}})},cancel:!0})}function k(e,i,o){if(1==e){var n=$(".pictureCheckbox:checked");if(0==n.length)return dialogOk("请选择照片",200,""),!1;n.each(function(e){var t=jQuery.parseJSON($(n[e]).val());i+=0==e?""+t.relation_id:","+t.relation_id,o=t.folder_id})}var l=C(o);if(l)art.dialog({content:'<div class="row" style="margin:0px;width: 500px;line-height: 34px;"><div class="col-md-2">移动到：</div><div class="col-md-10">'+l+"</div></div>",fixed:!0,id:"Fm7",okVal:"确定",title:"移动照片",ok:function(){var n=$("#galleryid").val();$.ajax({type:"POST",url:url_path_action+"/space/gallery/move_pictures",async:!1,dataType:"json",data:{relation_ids:i,from_folder_id:o,to_folder_id:n,business_type:R},success:function(i){i.success?(dialogClose("操作成功！",2,200,""),t(),a(),window.scrollTo(0,0),c("1",A,"replace"),1==e&&$(":checkbox").attr("checked",!1)):dialogOk(i.info,300,"")}})},cancel:!0});else art.dialog.alert("未发现其他相册！")}function C(e){var t="";if($.ajax({type:"GET",url:url_path_action_login+"/space/gallery/get_galleryfolder?person_id="+j+"&identity_id="+G+"&random_num="+creatRandomNum()+"&business_type="+R,async:!1,dataType:"json",success:function(a){if(a.success){var i=0;if((i=a.folder_list.length)>0)for(var o=0;o<i;o++)e!=a.folder_list[o].id&&(t=t+"<option value='"+a.folder_list[o].id+"'>"+a.folder_list[o].folder_name+"</option>")}else art.dialog.alert(a.info)}}),""==t)return!1;return"<select id='galleryid' class='form-control'>"+t+"</select>"}function x(e,i,o){var n=0;if(1==e){var l=$(".pictureCheckbox:checked");if(0==(n=l.length))return dialogOk("请选择照片",200,""),!1;l.each(function(e){var t=jQuery.parseJSON($(l[e]).val());i+=0==e?""+t.relation_id:","+t.relation_id,o=t.folder_id})}else n=1;art.dialog.confirm(1==n?"确定要删除该照片吗?":"确定要删除这些照片吗?",function(){$.ajax({type:"POST",url:url_path_action+"/space/gallery/delete_picture",async:!1,dataType:"json",data:{relation_ids:i,folder_id:o,person_id:j,identity_id:G,business_type:R},success:function(i){i.success?(dialogClose("操作成功！",2,200,""),t(),a(),window.scrollTo(0,0),c("1",A,"replace"),1==e&&$(":checkbox").attr("checked",!1)):dialogOk(i.info,300,"")}})},function(){})}function w(e){$(e).attr("checked")?($("#myGallery input[name='pictureCheckbox']").attr("checked",!0),$("#myGallery .gallery-item").addClass("checked")):($("input[name='pictureCheckbox']").attr("checked",!1),$("#myGallery .gallery-item").removeClass("checked"))}function T(e){switch(e){case"person_id":return j;case"identity_id":return G;case"page_number":return N;case"page_size":return A;case"business_type":return R;case"total_page":return Q;case"total_row":return O;case"cur_category":return I;case"allViewPhoneData":return z;case"visit_to":return P}}function S(){$.get("../tpl/main/main_gallery_tpl.html",function(e){$("#main").html(e),loadScripts(new Array("../../../css/space/space_gallery.css"),0,function(){if(null!=GetQueryString("id")&&null!=GetQueryString("identity_id"))j=GetQueryString("id"),G=GetQueryString("identity_id"),P=null==$.cookie("person_id")?1:$.cookie("person_id")==j&&$.cookie("identity_id")==G?3:2;else{if(null==$.cookie("person_id"))return top.location=url_path_html+personalLogoutAddr,!1;j=$.cookie("person_id"),G=$.cookie("identity_id"),P=3}$.cookie("person_id")&&$.cookie("person_id")==j&&$.cookie("identity_id")&&$.cookie("identity_id")==G&&(is_self_login=!0);var e={};e.visit_to=P,$("#mainGallery").html(template("mainGallery_inner",e)),null!=I&&""!=I?($(".batch-op .batch-move").show(),$(".batch-op .batch-remove").show(),$(".batch-op .checkbox").show()):($(".batch-op .batch-move").hide(),$(".batch-op .batch-remove").hide(),$(".batch-op .checkbox").hide()),t(),a(),c(N,A,"replace");$(".fancybox").fancybox({maxWidth:1200,minWidth:600,beforeLoad:function(){return this.width=1200,this.height=600,!0},afterShow:function(){$(".fancybox-next").hide(),$(".fancybox-prev").hide(),$(this.content)[0].contentWindow.loadImage()}})})})}var j,G,P,O,M,D,E,N=1,R="1",A=20,Q=1,I="",z=[];return{start:S,doupload:e,getGalleryStatistics:t,getGalleryCategory:a,galleryCategoryManage:o,editSortManage:l,delSortManage:r,getMyGallery:c,comment:g,addPraise:m,addDownLoadNum:h,editPhoto:b,movePhotoToFolder:k,removePhoto:x,checkAll:w,getParamValue:T}}();